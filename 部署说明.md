# Xray Reality 部署脚本使用说明

本项目提供了两个脚本来帮助你快速部署和管理 Xray Reality 服务。

## 脚本说明

### 1. deploy.sh - 完整部署脚本
这是一个交互式的完整部署脚本，支持多种配置选项。

**功能特性：**
- 自动检测系统环境
- 检查 Docker 环境（需要预先安装）
- 支持选择部署模式（Reality/xhttp Reality/两者都部署）
- 支持自定义端口和配置参数
- 安全的密钥生成机制（优先使用 OpenSSL，备用随机生成）
- 自动配置防火墙
- 显示详细的配置信息和管理命令

**使用方法：**
```bash
./deploy.sh
```

然后按照提示选择配置选项即可。

### 2. manage.sh - 管理脚本
用于管理已部署的 Xray Reality 容器。

**功能特性：**
- 查看容器状态
- 查看配置信息
- 查看实时日志
- 重启/停止/启动容器
- 删除容器
- 更新镜像并重新部署

**使用方法：**
```bash
./manage.sh
```

## 部署步骤

### 前置要求

**服务器环境：**
- Linux 服务器（Ubuntu/CentOS/Debian 等）
- 至少 1GB 内存
- 公网 IP 地址

**安装 Docker（必须）：**
```bash
# 下载并安装 Docker
curl -fsSL get.docker.com -o get-docker.sh && sh get-docker.sh

# 启动 Docker 服务
sudo systemctl start docker
sudo systemctl enable docker

# 将当前用户添加到 docker 组（可选，避免使用 sudo）
sudo usermod -aG docker $USER

# 重新登录或运行以下命令使组权限生效
newgrp docker
```

**验证 Docker 安装：**
```bash
docker --version
docker ps
```

## 密钥生成机制

由于新版本 Xray 的 `x25519` 命令输出格式发生变化，脚本现在使用多重密钥生成机制：

### 1. 主要方法：OpenSSL 生成（推荐）
- 使用 OpenSSL 生成标准 X25519 密钥对
- 符合 Reality 协议要求
- 安全性最高

### 2. 备用方法：简化随机生成
- 当 OpenSSL 不可用时使用
- 使用系统随机数源生成
- ⚠️ 不完全符合 X25519 标准，建议部署后手动更新

### 3. 失败处理
- 当所有方法都失败时，脚本会退出并提示用户
- 建议安装 OpenSSL 或手动指定私钥

### 密钥生成时机
- **默认配置**：自动生成密钥对
- **自定义配置**：可选择自定义私钥或自动生成

### 手动更新密钥（推荐）
如果希望使用更安全的密钥，可以：
1. 部署完成后停止容器
2. 使用新的私钥重新启动容器
3. 或使用 `./manage.sh` 脚本的更新功能

### 环境要求
为了确保密钥生成成功，建议：
- **Ubuntu/Debian**: `sudo apt install openssl`
- **CentOS/RHEL**: `sudo yum install openssl`
- 确保系统支持 `/dev/urandom`

## 部署步骤

1. 确保已安装 Docker
2. 上传脚本到服务器
3. 运行部署脚本：
   ```bash
   ./deploy.sh
   ```
4. 按照提示选择配置
5. 等待部署完成
6. 记录生成的配置信息
```

### 方式一：完整部署（推荐新手）

1. 确保已安装 Docker
2. 上传脚本到服务器
2. 运行部署脚本：
   ```bash
   ./deploy.sh
   ```
3. 按照提示选择配置
4. 等待部署完成
5. 记录生成的配置信息

### 方式二：快速部署

1. 确保已安装 Docker
2. 上传脚本到服务器
2. 运行快速部署：
   ```bash
   ./quick_deploy.sh
   ```
3. 等待部署完成
4. 查看配置信息：
   ```bash
   docker exec -it xray_reality cat /config_info.txt
   docker exec -it xray_xhttp_reality cat /config_info.txt
   ```

## 常用管理命令

### 查看容器状态
```bash
docker ps
```

### 查看配置信息
```bash
# Reality 模式
docker exec -it xray_reality cat /config_info.txt

# xhttp Reality 模式  
docker exec -it xray_xhttp_reality cat /config_info.txt
```

### 查看日志
```bash
# Reality 模式
docker logs -f xray_reality

# xhttp Reality 模式
docker logs -f xray_xhttp_reality
```

### 重启容器
```bash
# Reality 模式
docker restart xray_reality

# xhttp Reality 模式
docker restart xray_xhttp_reality
```

### 停止容器
```bash
# Reality 模式
docker stop xray_reality

# xhttp Reality 模式
docker stop xray_xhttp_reality
```

### 删除容器
```bash
# Reality 模式
docker rm -f xray_reality

# xhttp Reality 模式
docker rm -f xray_xhttp_reality
```

## 端口配置

### 默认端口
- Reality 模式：2333
- xhttp Reality 模式：23333

### 自定义端口
使用 `deploy.sh` 脚本可以自定义端口，确保：
1. 端口未被占用
2. 防火墙已开放对应端口
3. 如果使用云服务器，需要在安全组中开放端口

## 防火墙配置

### Ubuntu/Debian
```bash
sudo ufw allow 2333/tcp
sudo ufw allow 23333/tcp
```

### CentOS/RHEL
```bash
sudo firewall-cmd --permanent --add-port=2333/tcp
sudo firewall-cmd --permanent --add-port=23333/tcp
sudo firewall-cmd --reload
```

## 客户端配置

部署完成后，你会得到类似以下的配置信息：

```
IPV4: xxx.xxx.xxx.xxx
UUID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
PORT: 2333
SERVERNAMES: www.apple.com images.apple.com (任选其一)
PUBLICKEY: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
NETWORK: tcp
```

使用支持 Xray Reality 的客户端（如 v2rayN、Clash Meta 等）导入配置：

- **协议**: VLESS
- **地址**: 服务器 IP
- **端口**: 配置中的端口
- **UUID**: 配置中的 UUID
- **传输协议**: tcp (Reality 模式) 或 xhttp (xhttp Reality 模式)
- **TLS**: reality
- **SNI**: 选择一个 SERVERNAMES 中的域名
- **公钥**: 配置中的 PUBLICKEY
- **流控**: xtls-rprx-vision (仅 Reality 模式)

## 故障排除

### 1. 容器无法启动
- 检查端口是否被占用：`netstat -tuln | grep :端口号`
- 查看容器日志：`docker logs 容器名`
- 检查 Docker 服务状态：`systemctl status docker`

### 2. 无法连接
- 确认防火墙已开放端口
- 检查云服务器安全组设置
- 验证客户端配置是否正确

### 3. 配置信息丢失
- 重新查看配置：`docker exec -it 容器名 cat /config_info.txt`
- 查看容器日志：`docker logs 容器名`

### 4. 需要重新生成配置
- 删除现有容器：`docker rm -f 容器名`
- 重新运行部署脚本

## 更新升级

使用管理脚本的更新功能：
```bash
./manage.sh
# 选择选项 9) 更新镜像并重新部署
```

或手动更新：
```bash
# 停止容器
docker stop 容器名

# 删除容器
docker rm 容器名

# 拉取最新镜像
docker pull wulabing/xray_docker_reality:latest

# 重新运行容器
# (使用之前的部署命令)
```

## 注意事项

1. **安全性**：不要将 UUID、私钥等敏感信息泄露给他人
2. **备份**：建议保存好配置信息，以便重新部署时使用
3. **更新**：定期更新镜像以获得最新功能和安全修复
4. **监控**：定期检查容器运行状态和日志
5. **网络**：确保服务器网络连接稳定

## 技术支持

如果遇到问题，可以：
1. 查看项目 GitHub 页面：https://github.com/wulabing/xray_docker
2. 检查 Xray 官方文档
3. 使用管理脚本查看详细日志和状态

---

**项目地址**: https://github.com/wulabing/xray_docker  
**脚本作者**: GitHub Copilot  
**更新日期**: 2025-09-06
